<!DOCTYPE html> 
<html> 
	<head> 
		<meta charset="utf-8">
		<title>カメラ　テスト</title> 
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
		<script src="http://cdn.mlkcca.com/v2.0.0/milkcocoa.js"></script>

		<script type="text/javascript">
			// var _gaq = _gaq || [];
			// _gaq.push(['_setAccount', 'UA-33907251-1']);
			// _gaq.push(['_setDomainName', 'o24.me']);
			// _gaq.push(['_trackPageview']);
			// (function() {
			// 	var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			// 	ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			// 	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			// })();
		</script>
		
		<style>
			canvas,video{
				width:150px;
				height:100px;
				border:1px solid #aaaaaa;
			}
			#playPct{
				width:280px;
				height:180px;	
				 overflow: hidden;
			}
			
			#playPct img{
				width:620px;	
			}
			button {
				border:1px solid #eeeeee;
				width:100px;
				height:30px;
				color:white;
			}
			#capture {
				background-color:#008800;
			}
			#stop {
				background-color:#008888;
			}
			#startShot {
				background-color:#000088;
			}
			#startCamera{
				background-color:#880000;	
			}
			.shotImage{
				width:50px;
			}
			textarea{
				height:2em;
			}

		</style>
	</head> 
	<body> 
		<h1 id="title"></h1>
		<div class="postarea-text">
	          <textarea name="" id="titleVal" cols="30" rows="10" placeholder="titleを入力"></textarea><button id="pushTitle">title push</button>
	    </div>
		<video autoplay ></video>
		<canvas style="display:none;"></canvas>
		<div id="wrapper">
			<button id="startCamera">1.start Camera</button>
			<!-- <button id="capture">capture</button> -->
			<button id="startShot">2. start shot</button>
			<!-- <button id="stop">stop</button> -->
		</div>
		<div id="shotedPct"></div>
		<div id="playPct"><img /></div>
		<button id="playVideo">play Mov</button>
		<button id="stopPct">stop Mov</button>
		<!-- <a id="download" target="_blank">ダウンロード(IEでは、右クリック>対象をファイルに保存)</a> -->
	</body>
	<script>
	$(function() {
		var video = document.querySelector('video');
		var canvas = document.querySelector('canvas');
		var ctx = canvas.getContext('2d');
		var localMediaStream = null;
		var shotInterval, playVideoInterval, pushInterval;
		var shotCounter = 0, maxShot = 20, shotSpeed = 200;
		var shotArray = [];
		var playCounter = 0;
		var setTitleStr = '';
		/////////milkcocoa
		//1.ミルクココアインスタンスを作成
        var milkcocoa = new MilkCocoa("blueiasuq2hz.mlkcca.com");
        //2."message"データストアを作成
        var ds = milkcocoa.dataStore("fuuFace");
        //データストアからすべてのデータを取得する配列
        var dsAllData =[];
        var primaryId = 0;
        //pushのカウンター
        var pushCounter = 0;

        //データストアからすべてのデータを取得
        ds.stream().sort("desc").size(999).next(function(err, datas) {
            console.log('data.lengths'+ datas.length);
            primaryId = datas.length;
            // console.log(datas);
            datas.forEach(function(data) {
                dsAllData.push(data.value);
            });
        });

        var getNumSort = function(sortNum, mode){
        	//mode "desc"降順,"asc"昇順
        	shotArray = [];
        	playCounter = 0;
        	ds.stream().sort(mode).size(sortNum).next(function(err, datas) {
	            // console.log(datas);
	            datas.forEach(function(data) {
	                shotArray.push(data.value.url);
	                console.log("shotArray.length", shotArray.length)
	                console.log("title: ", data.value.title);
	                console.log("id: ", data.value.id);
	                console.log("id: ", data.value.url);
	            });
	        });

        }

        //4."message"データストアのプッシュイベントを監視
        ds.on("push", function(e) {
            // renderMessage(e.value);
			// playVideo();
			console.log('push完了');
			pushCounter ++;
			// console.log('shotArray.length', shotArray.length);
			// console.log('pushCounter', pushCounter );
			if(pushCounter == maxShot){
				// getNumSort(maxShot);
				playVideo();
				console.log('start anime');
				pushCounter = 0;
				shotArray = [];
			}
        });


        //milkcocoaデータストアにプッシュ　引数1タイトル、引数2コンテンツ（風量）
        function post(titleStr, contentStr) {
            var titleStr = escapeHTML(titleStr) || 'タイトルなし';
            var name = '名無しさん';
            //5."message"データストアにメッセージをプッシュする
            var content = escapeHTML(contentStr);
            // var content = contentStr;
     		// console.log('contentStr', typeof contentStr);
            if (content && content !== "") { 
	            console.log('milkcocoa push')
	            // console.log(content);
                primaryId++;
                ds.push({
                    id:primaryId,
                    title: titleStr,
                    name: name,
                    url: content,
                    date: new Date().getTime()
                }, function (e) {});
            }        
        }

        //インジェクション対策
        function escapeHTML(val) {
        	var val = val;
        	if(val == undefined){
        		console.log('val', 'undefinedみたい')
        		return;
        	}
        	console.log('val', val);
			return $('<div>').text(val).html();
		};

		//カメラ使えるかチェック
		var hasGetUserMedia = function() {
			return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
				navigator.mozGetUserMedia || navigator.msGetUserMedia);
		}
		//エラー
		var onFailSoHard = function(e) {
			console.log('エラー!', e);
		};

		//カメラ画像キャプチャ
		var snapshot = function() {
			var targetWidth = $(video).width()/1.1 ;
			var targetHeight = $(video).height()/1.1 ;
			if (localMediaStream) {
				ctx.drawImage(video, 0, 0, targetWidth, targetHeight);
				console.log(canvas.toDataURL('image/webp'));
				//キャプチャした画像を配列に格納
				shotArray.push(canvas.toDataURL('image/webp'));
				document.querySelector('img').src = canvas.toDataURL('image/webp');
				//milkcocoaへ送信
				// post(setTitleStr, shotArray[shotCounter]);
				shotCounter ++;
				// console.log('shotCounter:', shotCounter);
				if(shotCounter == maxShot){
					console.log("定数に達したので止めます")
					//milkcocoaへ送信
					for(var i = 0; i < maxShot; i++){
						post(setTitleStr, shotArray[i]);	
					}
					stopShot();
					shotCounter = 0;
					console.log("空へ");
					shotArray = [];
				}
			}
		}

		//連続撮影
		var startShot = function(){
			shotInterval = setInterval(snapshot, shotSpeed);
		}

		//連続撮影のストップ
		var stopShot = function(){
			clearInterval(shotInterval);
			localMediaStream.stop();
			//撮影した写真の出力
			// for(var i = 0; i < shotArray.length; i++){
			// 	// console.log('shotArray: ', i , shotArray[i]);
			// 	$('#shotedPct').append('<img clas="shotImage" id="shotImage' + i +'" src="' + shotArray[i] +'" alt="" />')
			// }
		}
		// 再生動画を停止
		var stopPct = function(){
			clearInterval(playVideoInterval);
		}

		//撮影したビデオを再生
		var playVideo = function(){
				getNumSort(maxShot, "dsc");
				if(shotArray.length == undefined){
					console.log("データベースが空みたい");
					return;
				}
				//写真をBase64のファイルへ出力
				// setBlobUrl("download", shotArray);
				playVideoInterval = setInterval(setImage, shotSpeed);
				console.log("playStart")
		}
		//写真を差し替えて疑似アニメーション
		var setImage = function(){
			var url = shotArray[playCounter];
			console.log("from setImage url", url);
			var img_url = String(url);
			$("#playPct").children("img").attr({'src':img_url});
			console.log('playCounter: ', playCounter);
			playCounter++;
			if(playCounter == maxShot){
				clearInterval(playVideoInterval);
				playCounter = 0;
				console.log('finish');
				shotArray = [];
			}
		}

		if (hasGetUserMedia()) {
			console.log("カメラ OK");
		} else {
			alert("未対応ブラウザです。");
		}


		window.URL = window.URL || window.webkitURL;
		navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia ||
								  navigator.mozGetUserMedia || navigator.msGetUserMedia;

		
		var startCamera = function(){
			navigator.getUserMedia({video: true}, function(stream) {
			  video.src = window.URL.createObjectURL(stream);
			  localMediaStream = stream;
			}, onFailSoHard);	
		}

		//ボタンイベント
		$("#startCamera").click(function() {
			startCamera();
		});
		$("#capture").click(function() {
			snapshot();
		});
		$("#stop").click(function() {
			stopShot();
		});
		$("video").click(function() {
			snapshot();
		});
		$("#startShot").click(function() {
			// shotArray = [];
			startShot();
		});
		$("#playVideo").click(function() {
			playVideo();
		});
		$("#stopPct").click(function() {
			stopPct();
		});

		$("#pushTitle").click(function() {
			setTitleStr = escapeHTML($('#titleVal').val());
			$("#title").text(setTitleStr);
		});

		////////////ファイルの保存　idへダウンロードリンクの張り直し
		function setBlobUrl(id, content) {
		 // 指定されたデータを保持するBlobを作成する。
		    var blob = new Blob([ content ], { "type" : "application/x-msdownload" });
		 
		 // Aタグのhref属性にBlobオブジェクトを設定し、リンクを生成
		    window.URL = window.URL || window.webkitURL;
		    $("#" + id).attr("href", window.URL.createObjectURL(blob));
		    $("#" + id).attr("download", "playBase64.txt");
		}
	});



	</script>
</html>